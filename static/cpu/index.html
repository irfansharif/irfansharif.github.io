<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=lhDjYqiy3mZ0x6ROQEUoUw');ul.lst-kix_tttr5koclxv9-6{list-style-type:none}ul.lst-kix_tttr5koclxv9-7{list-style-type:none}ul.lst-kix_tttr5koclxv9-8{list-style-type:none}ul.lst-kix_tttr5koclxv9-2{list-style-type:none}ul.lst-kix_tttr5koclxv9-3{list-style-type:none}ul.lst-kix_m3aaeizidpga-0{list-style-type:none}ul.lst-kix_tttr5koclxv9-4{list-style-type:none}ul.lst-kix_m3aaeizidpga-1{list-style-type:none}ul.lst-kix_tttr5koclxv9-5{list-style-type:none}ul.lst-kix_tttr5koclxv9-0{list-style-type:none}ul.lst-kix_tttr5koclxv9-1{list-style-type:none}.lst-kix_26xw8ufkmoyn-5>li:before{content:"-  "}.lst-kix_26xw8ufkmoyn-3>li:before{content:"-  "}.lst-kix_26xw8ufkmoyn-7>li:before{content:"-  "}.lst-kix_26xw8ufkmoyn-2>li:before{content:"-  "}.lst-kix_26xw8ufkmoyn-6>li:before{content:"-  "}ul.lst-kix_m3aaeizidpga-2{list-style-type:none}.lst-kix_26xw8ufkmoyn-1>li:before{content:"-  "}ul.lst-kix_m3aaeizidpga-3{list-style-type:none}ul.lst-kix_m3aaeizidpga-4{list-style-type:none}ul.lst-kix_m3aaeizidpga-5{list-style-type:none}ul.lst-kix_m3aaeizidpga-6{list-style-type:none}ul.lst-kix_m3aaeizidpga-7{list-style-type:none}ul.lst-kix_m3aaeizidpga-8{list-style-type:none}.lst-kix_26xw8ufkmoyn-0>li:before{content:"-  "}.lst-kix_26xw8ufkmoyn-8>li:before{content:"-  "}.lst-kix_26xw8ufkmoyn-4>li:before{content:"-  "}ul.lst-kix_t2ertrluue2s-6{list-style-type:none}ul.lst-kix_t2ertrluue2s-7{list-style-type:none}ul.lst-kix_t2ertrluue2s-8{list-style-type:none}ul.lst-kix_t2ertrluue2s-2{list-style-type:none}ul.lst-kix_t2ertrluue2s-3{list-style-type:none}ul.lst-kix_t2ertrluue2s-4{list-style-type:none}ul.lst-kix_t2ertrluue2s-5{list-style-type:none}ul.lst-kix_t2ertrluue2s-0{list-style-type:none}ul.lst-kix_t2ertrluue2s-1{list-style-type:none}.lst-kix_m3aaeizidpga-8>li:before{content:"-  "}.lst-kix_m3aaeizidpga-3>li:before{content:"-  "}.lst-kix_m3aaeizidpga-7>li:before{content:"-  "}.lst-kix_m3aaeizidpga-5>li:before{content:"-  "}.lst-kix_gclj53ptxn94-2>li:before{content:"\0025a0  "}.lst-kix_m3aaeizidpga-1>li:before{content:"-  "}.lst-kix_gclj53ptxn94-0>li:before{content:"\0025cf  "}.lst-kix_fntvcn41blca-3>li:before{content:"\0025cf  "}.lst-kix_fntvcn41blca-7>li:before{content:"\0025cb  "}.lst-kix_8kn17h8ds170-0>li:before{content:"\0025cf  "}.lst-kix_fntvcn41blca-1>li:before{content:"\0025cb  "}ul.lst-kix_21gqoytoyzk-6{list-style-type:none}ul.lst-kix_21gqoytoyzk-5{list-style-type:none}ul.lst-kix_21gqoytoyzk-8{list-style-type:none}ul.lst-kix_21gqoytoyzk-7{list-style-type:none}ul.lst-kix_21gqoytoyzk-0{list-style-type:none}ul.lst-kix_21gqoytoyzk-2{list-style-type:none}ul.lst-kix_21gqoytoyzk-1{list-style-type:none}ul.lst-kix_21gqoytoyzk-4{list-style-type:none}.lst-kix_fntvcn41blca-5>li:before{content:"\0025a0  "}ul.lst-kix_21gqoytoyzk-3{list-style-type:none}.lst-kix_t2ertrluue2s-0>li:before{content:"-  "}.lst-kix_hsnn8cb3mf5v-6>li:before{content:"-  "}.lst-kix_hsnn8cb3mf5v-4>li:before{content:"-  "}.lst-kix_hsnn8cb3mf5v-8>li:before{content:"-  "}.lst-kix_kyi9mzn49gim-4>li:before{content:"-  "}.lst-kix_kyi9mzn49gim-8>li:before{content:"-  "}.lst-kix_ypwh9jlsbvp5-2>li:before{content:"-  "}.lst-kix_t2ertrluue2s-2>li:before{content:"-  "}.lst-kix_kyi9mzn49gim-6>li:before{content:"-  "}.lst-kix_ypwh9jlsbvp5-0>li:before{content:"-  "}.lst-kix_ypwh9jlsbvp5-8>li:before{content:"-  "}.lst-kix_hsnn8cb3mf5v-0>li:before{content:"-  "}.lst-kix_kyi9mzn49gim-0>li:before{content:"-  "}.lst-kix_ypwh9jlsbvp5-6>li:before{content:"-  "}.lst-kix_hsnn8cb3mf5v-2>li:before{content:"-  "}.lst-kix_kyi9mzn49gim-2>li:before{content:"-  "}.lst-kix_ypwh9jlsbvp5-4>li:before{content:"-  "}ul.lst-kix_lometsw9ge27-1{list-style-type:none}ul.lst-kix_8kn17h8ds170-7{list-style-type:none}ul.lst-kix_lometsw9ge27-0{list-style-type:none}ul.lst-kix_8kn17h8ds170-8{list-style-type:none}.lst-kix_gclj53ptxn94-4>li:before{content:"\0025cb  "}.lst-kix_gclj53ptxn94-6>li:before{content:"\0025cf  "}ul.lst-kix_8kn17h8ds170-1{list-style-type:none}ul.lst-kix_8kn17h8ds170-2{list-style-type:none}ul.lst-kix_8kn17h8ds170-0{list-style-type:none}ul.lst-kix_8kn17h8ds170-5{list-style-type:none}ul.lst-kix_8kn17h8ds170-6{list-style-type:none}.lst-kix_gclj53ptxn94-8>li:before{content:"\0025a0  "}ul.lst-kix_8kn17h8ds170-3{list-style-type:none}ul.lst-kix_8kn17h8ds170-4{list-style-type:none}.lst-kix_tttr5koclxv9-8>li:before{content:"-  "}.lst-kix_tttr5koclxv9-7>li:before{content:"-  "}.lst-kix_tttr5koclxv9-4>li:before{content:"-  "}.lst-kix_t453qbeg7yxi-6>li:before{content:"-  "}ul.lst-kix_cntx4tdr3vpo-0{list-style-type:none}.lst-kix_t453qbeg7yxi-3>li:before{content:"-  "}.lst-kix_t453qbeg7yxi-7>li:before{content:"-  "}ul.lst-kix_cntx4tdr3vpo-1{list-style-type:none}ul.lst-kix_lometsw9ge27-7{list-style-type:none}ul.lst-kix_lometsw9ge27-6{list-style-type:none}ul.lst-kix_lometsw9ge27-8{list-style-type:none}ul.lst-kix_lometsw9ge27-3{list-style-type:none}ul.lst-kix_lometsw9ge27-2{list-style-type:none}ul.lst-kix_lometsw9ge27-5{list-style-type:none}ul.lst-kix_lometsw9ge27-4{list-style-type:none}.lst-kix_6uv5cm836ttd-2>li:before{content:"-  "}.lst-kix_6uv5cm836ttd-3>li:before{content:"-  "}.lst-kix_21gqoytoyzk-1>li:before{content:"\0025cb  "}.lst-kix_tttr5koclxv9-0>li:before{content:"-  "}.lst-kix_21gqoytoyzk-0>li:before{content:"\0025cf  "}.lst-kix_21gqoytoyzk-4>li:before{content:"\0025cb  "}.lst-kix_tttr5koclxv9-3>li:before{content:"-  "}.lst-kix_6uv5cm836ttd-6>li:before{content:"-  "}.lst-kix_t2ertrluue2s-4>li:before{content:"-  "}.lst-kix_t2ertrluue2s-8>li:before{content:"-  "}.lst-kix_t2ertrluue2s-5>li:before{content:"-  "}.lst-kix_6uv5cm836ttd-7>li:before{content:"-  "}.lst-kix_21gqoytoyzk-8>li:before{content:"\0025a0  "}.lst-kix_21gqoytoyzk-5>li:before{content:"\0025a0  "}ul.lst-kix_8zh4qso6zamb-7{list-style-type:none}ul.lst-kix_ypwh9jlsbvp5-5{list-style-type:none}.lst-kix_cntx4tdr3vpo-0>li:before{content:"-  "}ul.lst-kix_8zh4qso6zamb-6{list-style-type:none}ul.lst-kix_ypwh9jlsbvp5-4{list-style-type:none}ul.lst-kix_ypwh9jlsbvp5-7{list-style-type:none}ul.lst-kix_8zh4qso6zamb-8{list-style-type:none}ul.lst-kix_ypwh9jlsbvp5-6{list-style-type:none}ul.lst-kix_ypwh9jlsbvp5-1{list-style-type:none}.lst-kix_8kn17h8ds170-5>li:before{content:"\0025a0  "}ul.lst-kix_ypwh9jlsbvp5-0{list-style-type:none}ul.lst-kix_ypwh9jlsbvp5-3{list-style-type:none}.lst-kix_8kn17h8ds170-4>li:before{content:"\0025cb  "}ul.lst-kix_ypwh9jlsbvp5-2{list-style-type:none}.lst-kix_fznhohgbnnb3-0>li:before{content:"-  "}ul.lst-kix_8zh4qso6zamb-1{list-style-type:none}ul.lst-kix_8zh4qso6zamb-0{list-style-type:none}ul.lst-kix_8zh4qso6zamb-3{list-style-type:none}ul.lst-kix_8zh4qso6zamb-2{list-style-type:none}ul.lst-kix_8zh4qso6zamb-5{list-style-type:none}ul.lst-kix_8zh4qso6zamb-4{list-style-type:none}.lst-kix_cntx4tdr3vpo-8>li:before{content:"-  "}.lst-kix_fznhohgbnnb3-4>li:before{content:"-  "}.lst-kix_sajvd0vs1jci-7>li:before{content:"-  "}.lst-kix_fznhohgbnnb3-3>li:before{content:"-  "}.lst-kix_sajvd0vs1jci-4>li:before{content:"-  "}.lst-kix_sajvd0vs1jci-8>li:before{content:"-  "}.lst-kix_t453qbeg7yxi-2>li:before{content:"-  "}.lst-kix_cntx4tdr3vpo-1>li:before{content:"-  "}ul.lst-kix_6uv5cm836ttd-8{list-style-type:none}.lst-kix_8kn17h8ds170-8>li:before{content:"\0025a0  "}.lst-kix_sajvd0vs1jci-0>li:before{content:"-  "}ul.lst-kix_6uv5cm836ttd-6{list-style-type:none}.lst-kix_cntx4tdr3vpo-4>li:before{content:"-  "}.lst-kix_fznhohgbnnb3-8>li:before{content:"-  "}.lst-kix_sajvd0vs1jci-3>li:before{content:"-  "}ul.lst-kix_6uv5cm836ttd-7{list-style-type:none}ul.lst-kix_6uv5cm836ttd-4{list-style-type:none}.lst-kix_cntx4tdr3vpo-5>li:before{content:"-  "}.lst-kix_fznhohgbnnb3-7>li:before{content:"-  "}ul.lst-kix_6uv5cm836ttd-5{list-style-type:none}ul.lst-kix_6uv5cm836ttd-2{list-style-type:none}ul.lst-kix_6uv5cm836ttd-3{list-style-type:none}ul.lst-kix_6uv5cm836ttd-0{list-style-type:none}ul.lst-kix_6uv5cm836ttd-1{list-style-type:none}ul.lst-kix_t453qbeg7yxi-2{list-style-type:none}.lst-kix_m3aaeizidpga-2>li:before{content:"-  "}ul.lst-kix_t453qbeg7yxi-1{list-style-type:none}ul.lst-kix_t453qbeg7yxi-4{list-style-type:none}ul.lst-kix_t453qbeg7yxi-3{list-style-type:none}ul.lst-kix_t453qbeg7yxi-0{list-style-type:none}ul.lst-kix_26xw8ufkmoyn-5{list-style-type:none}ul.lst-kix_nne9wb5yxxw-8{list-style-type:none}.lst-kix_m3aaeizidpga-6>li:before{content:"-  "}ul.lst-kix_26xw8ufkmoyn-6{list-style-type:none}ul.lst-kix_nne9wb5yxxw-7{list-style-type:none}ul.lst-kix_26xw8ufkmoyn-7{list-style-type:none}ul.lst-kix_nne9wb5yxxw-6{list-style-type:none}ul.lst-kix_26xw8ufkmoyn-8{list-style-type:none}ul.lst-kix_nne9wb5yxxw-5{list-style-type:none}ul.lst-kix_t453qbeg7yxi-6{list-style-type:none}ul.lst-kix_t453qbeg7yxi-5{list-style-type:none}ul.lst-kix_t453qbeg7yxi-8{list-style-type:none}ul.lst-kix_t453qbeg7yxi-7{list-style-type:none}.lst-kix_gclj53ptxn94-1>li:before{content:"\0025cb  "}.lst-kix_fntvcn41blca-4>li:before{content:"\0025cb  "}.lst-kix_8kn17h8ds170-1>li:before{content:"\0025cb  "}.lst-kix_2g996f9jiukn-3>li:before{content:"-  "}.lst-kix_fntvcn41blca-0>li:before{content:"\0025cf  "}.lst-kix_fntvcn41blca-8>li:before{content:"\0025a0  "}ul.lst-kix_ypwh9jlsbvp5-8{list-style-type:none}ul.lst-kix_nne9wb5yxxw-0{list-style-type:none}ul.lst-kix_26xw8ufkmoyn-0{list-style-type:none}ul.lst-kix_26xw8ufkmoyn-1{list-style-type:none}ul.lst-kix_nne9wb5yxxw-4{list-style-type:none}ul.lst-kix_26xw8ufkmoyn-2{list-style-type:none}ul.lst-kix_nne9wb5yxxw-3{list-style-type:none}ul.lst-kix_26xw8ufkmoyn-3{list-style-type:none}ul.lst-kix_nne9wb5yxxw-2{list-style-type:none}ul.lst-kix_26xw8ufkmoyn-4{list-style-type:none}ul.lst-kix_nne9wb5yxxw-1{list-style-type:none}.lst-kix_kyi9mzn49gim-7>li:before{content:"-  "}.lst-kix_t2ertrluue2s-1>li:before{content:"-  "}.lst-kix_3jq1ezcn055d-2>li:before{content:"-  "}.lst-kix_ypwh9jlsbvp5-3>li:before{content:"-  "}.lst-kix_hsnn8cb3mf5v-5>li:before{content:"-  "}.lst-kix_3jq1ezcn055d-6>li:before{content:"-  "}.lst-kix_ypwh9jlsbvp5-7>li:before{content:"-  "}.lst-kix_sdd4j0g0i102-4>li:before{content:"-  "}.lst-kix_qvlhfeetlgn4-1>li:before{content:"-  "}.lst-kix_hsnn8cb3mf5v-1>li:before{content:"-  "}.lst-kix_kyi9mzn49gim-3>li:before{content:"-  "}.lst-kix_qvlhfeetlgn4-5>li:before{content:"-  "}.lst-kix_8zh4qso6zamb-1>li:before{content:"-  "}.lst-kix_sdd4j0g0i102-8>li:before{content:"-  "}.lst-kix_8zh4qso6zamb-5>li:before{content:"-  "}.lst-kix_lometsw9ge27-3>li:before{content:"-  "}ul.lst-kix_3jq1ezcn055d-3{list-style-type:none}ul.lst-kix_cntx4tdr3vpo-2{list-style-type:none}.lst-kix_lometsw9ge27-7>li:before{content:"-  "}ul.lst-kix_3jq1ezcn055d-2{list-style-type:none}ul.lst-kix_cntx4tdr3vpo-3{list-style-type:none}ul.lst-kix_3jq1ezcn055d-5{list-style-type:none}ul.lst-kix_cntx4tdr3vpo-4{list-style-type:none}ul.lst-kix_3jq1ezcn055d-4{list-style-type:none}ul.lst-kix_cntx4tdr3vpo-5{list-style-type:none}ul.lst-kix_cntx4tdr3vpo-6{list-style-type:none}ul.lst-kix_cntx4tdr3vpo-7{list-style-type:none}ul.lst-kix_3jq1ezcn055d-1{list-style-type:none}ul.lst-kix_cntx4tdr3vpo-8{list-style-type:none}ul.lst-kix_3jq1ezcn055d-0{list-style-type:none}.lst-kix_gclj53ptxn94-5>li:before{content:"\0025a0  "}ul.lst-kix_fntvcn41blca-3{list-style-type:none}ul.lst-kix_fntvcn41blca-4{list-style-type:none}ul.lst-kix_fntvcn41blca-5{list-style-type:none}ul.lst-kix_fntvcn41blca-6{list-style-type:none}ul.lst-kix_3jq1ezcn055d-7{list-style-type:none}ul.lst-kix_3jq1ezcn055d-6{list-style-type:none}ul.lst-kix_fntvcn41blca-0{list-style-type:none}ul.lst-kix_fntvcn41blca-1{list-style-type:none}ul.lst-kix_3jq1ezcn055d-8{list-style-type:none}ul.lst-kix_fntvcn41blca-2{list-style-type:none}.lst-kix_sdd4j0g0i102-0>li:before{content:"-  "}ul.lst-kix_hsnn8cb3mf5v-0{list-style-type:none}ul.lst-kix_hsnn8cb3mf5v-1{list-style-type:none}ul.lst-kix_hsnn8cb3mf5v-2{list-style-type:none}ul.lst-kix_hsnn8cb3mf5v-3{list-style-type:none}ul.lst-kix_hsnn8cb3mf5v-4{list-style-type:none}ul.lst-kix_hsnn8cb3mf5v-5{list-style-type:none}ul.lst-kix_hsnn8cb3mf5v-6{list-style-type:none}ul.lst-kix_hsnn8cb3mf5v-7{list-style-type:none}ul.lst-kix_hsnn8cb3mf5v-8{list-style-type:none}ul.lst-kix_gclj53ptxn94-3{list-style-type:none}ul.lst-kix_gclj53ptxn94-2{list-style-type:none}ul.lst-kix_gclj53ptxn94-1{list-style-type:none}ul.lst-kix_gclj53ptxn94-0{list-style-type:none}ul.lst-kix_fntvcn41blca-7{list-style-type:none}ul.lst-kix_fntvcn41blca-8{list-style-type:none}ul.lst-kix_gclj53ptxn94-8{list-style-type:none}ul.lst-kix_gclj53ptxn94-7{list-style-type:none}.lst-kix_lometsw9ge27-8>li:before{content:"-  "}ul.lst-kix_gclj53ptxn94-6{list-style-type:none}ul.lst-kix_gclj53ptxn94-5{list-style-type:none}ul.lst-kix_gclj53ptxn94-4{list-style-type:none}.lst-kix_nne9wb5yxxw-0>li:before{content:"-  "}ul.lst-kix_fznhohgbnnb3-8{list-style-type:none}ul.lst-kix_fznhohgbnnb3-6{list-style-type:none}ul.lst-kix_fznhohgbnnb3-7{list-style-type:none}ul.lst-kix_fznhohgbnnb3-4{list-style-type:none}ul.lst-kix_fznhohgbnnb3-5{list-style-type:none}ul.lst-kix_fznhohgbnnb3-2{list-style-type:none}ul.lst-kix_fznhohgbnnb3-3{list-style-type:none}ul.lst-kix_fznhohgbnnb3-0{list-style-type:none}ul.lst-kix_fznhohgbnnb3-1{list-style-type:none}.lst-kix_ks833lz1z7ql-5>li:before{content:"-  "}.lst-kix_ks833lz1z7ql-6>li:before{content:"-  "}.lst-kix_ks833lz1z7ql-8>li:before{content:"-  "}.lst-kix_ks833lz1z7ql-7>li:before{content:"-  "}.lst-kix_2g996f9jiukn-6>li:before{content:"-  "}.lst-kix_2g996f9jiukn-8>li:before{content:"-  "}.lst-kix_ks833lz1z7ql-4>li:before{content:"-  "}.lst-kix_ks833lz1z7ql-3>li:before{content:"-  "}.lst-kix_2g996f9jiukn-7>li:before{content:"-  "}.lst-kix_ks833lz1z7ql-2>li:before{content:"-  "}.lst-kix_2g996f9jiukn-4>li:before{content:"-  "}.lst-kix_ks833lz1z7ql-1>li:before{content:"-  "}.lst-kix_2g996f9jiukn-5>li:before{content:"-  "}.lst-kix_nne9wb5yxxw-1>li:before{content:"-  "}.lst-kix_nne9wb5yxxw-2>li:before{content:"-  "}.lst-kix_ks833lz1z7ql-0>li:before{content:"-  "}.lst-kix_nne9wb5yxxw-3>li:before{content:"-  "}.lst-kix_nne9wb5yxxw-4>li:before{content:"-  "}.lst-kix_nne9wb5yxxw-6>li:before{content:"-  "}.lst-kix_nne9wb5yxxw-5>li:before{content:"-  "}.lst-kix_nne9wb5yxxw-8>li:before{content:"-  "}.lst-kix_nne9wb5yxxw-7>li:before{content:"-  "}ul.lst-kix_sajvd0vs1jci-7{list-style-type:none}ul.lst-kix_sajvd0vs1jci-8{list-style-type:none}ul.lst-kix_sajvd0vs1jci-5{list-style-type:none}ul.lst-kix_sajvd0vs1jci-6{list-style-type:none}ul.lst-kix_sajvd0vs1jci-3{list-style-type:none}ul.lst-kix_sajvd0vs1jci-4{list-style-type:none}ul.lst-kix_sajvd0vs1jci-1{list-style-type:none}ul.lst-kix_sajvd0vs1jci-2{list-style-type:none}ul.lst-kix_sajvd0vs1jci-0{list-style-type:none}.lst-kix_2g996f9jiukn-0>li:before{content:"-  "}.lst-kix_2g996f9jiukn-2>li:before{content:"-  "}.lst-kix_3jq1ezcn055d-1>li:before{content:"-  "}.lst-kix_3jq1ezcn055d-5>li:before{content:"-  "}.lst-kix_sdd4j0g0i102-5>li:before{content:"-  "}.lst-kix_3jq1ezcn055d-7>li:before{content:"-  "}.lst-kix_qvlhfeetlgn4-0>li:before{content:"-  "}.lst-kix_qvlhfeetlgn4-2>li:before{content:"-  "}.lst-kix_8zh4qso6zamb-0>li:before{content:"-  "}.lst-kix_8zh4qso6zamb-2>li:before{content:"-  "}.lst-kix_sdd4j0g0i102-7>li:before{content:"-  "}.lst-kix_qvlhfeetlgn4-4>li:before{content:"-  "}.lst-kix_lometsw9ge27-2>li:before{content:"-  "}.lst-kix_8zh4qso6zamb-6>li:before{content:"-  "}.lst-kix_8zh4qso6zamb-4>li:before{content:"-  "}.lst-kix_lometsw9ge27-0>li:before{content:"-  "}.lst-kix_lometsw9ge27-4>li:before{content:"-  "}.lst-kix_qvlhfeetlgn4-6>li:before{content:"-  "}.lst-kix_lometsw9ge27-6>li:before{content:"-  "}.lst-kix_qvlhfeetlgn4-8>li:before{content:"-  "}.lst-kix_sdd4j0g0i102-1>li:before{content:"-  "}.lst-kix_sdd4j0g0i102-3>li:before{content:"-  "}.lst-kix_8zh4qso6zamb-8>li:before{content:"-  "}.lst-kix_3jq1ezcn055d-3>li:before{content:"-  "}.lst-kix_tttr5koclxv9-5>li:before{content:"-  "}ul.lst-kix_qvlhfeetlgn4-4{list-style-type:none}ul.lst-kix_qvlhfeetlgn4-3{list-style-type:none}.lst-kix_tttr5koclxv9-6>li:before{content:"-  "}ul.lst-kix_qvlhfeetlgn4-2{list-style-type:none}ul.lst-kix_qvlhfeetlgn4-1{list-style-type:none}ul.lst-kix_qvlhfeetlgn4-8{list-style-type:none}ul.lst-kix_qvlhfeetlgn4-7{list-style-type:none}ul.lst-kix_qvlhfeetlgn4-6{list-style-type:none}ul.lst-kix_qvlhfeetlgn4-5{list-style-type:none}ul.lst-kix_kyi9mzn49gim-0{list-style-type:none}ul.lst-kix_kyi9mzn49gim-1{list-style-type:none}.lst-kix_t453qbeg7yxi-8>li:before{content:"-  "}ul.lst-kix_kyi9mzn49gim-4{list-style-type:none}ul.lst-kix_qvlhfeetlgn4-0{list-style-type:none}ul.lst-kix_kyi9mzn49gim-5{list-style-type:none}ul.lst-kix_kyi9mzn49gim-2{list-style-type:none}ul.lst-kix_kyi9mzn49gim-3{list-style-type:none}ul.lst-kix_kyi9mzn49gim-8{list-style-type:none}ul.lst-kix_kyi9mzn49gim-6{list-style-type:none}.lst-kix_t453qbeg7yxi-4>li:before{content:"-  "}ul.lst-kix_kyi9mzn49gim-7{list-style-type:none}.lst-kix_t453qbeg7yxi-5>li:before{content:"-  "}.lst-kix_6uv5cm836ttd-0>li:before{content:"-  "}.lst-kix_6uv5cm836ttd-1>li:before{content:"-  "}.lst-kix_6uv5cm836ttd-4>li:before{content:"-  "}.lst-kix_21gqoytoyzk-2>li:before{content:"\0025a0  "}.lst-kix_tttr5koclxv9-1>li:before{content:"-  "}.lst-kix_6uv5cm836ttd-8>li:before{content:"-  "}.lst-kix_21gqoytoyzk-3>li:before{content:"\0025cf  "}.lst-kix_tttr5koclxv9-2>li:before{content:"-  "}.lst-kix_t2ertrluue2s-7>li:before{content:"-  "}.lst-kix_6uv5cm836ttd-5>li:before{content:"-  "}.lst-kix_t2ertrluue2s-6>li:before{content:"-  "}ul.lst-kix_2g996f9jiukn-8{list-style-type:none}ul.lst-kix_sdd4j0g0i102-8{list-style-type:none}ul.lst-kix_sdd4j0g0i102-7{list-style-type:none}ul.lst-kix_2g996f9jiukn-4{list-style-type:none}ul.lst-kix_2g996f9jiukn-5{list-style-type:none}ul.lst-kix_2g996f9jiukn-6{list-style-type:none}ul.lst-kix_2g996f9jiukn-7{list-style-type:none}.lst-kix_21gqoytoyzk-6>li:before{content:"\0025cf  "}ul.lst-kix_2g996f9jiukn-0{list-style-type:none}ul.lst-kix_2g996f9jiukn-1{list-style-type:none}.lst-kix_21gqoytoyzk-7>li:before{content:"\0025cb  "}ul.lst-kix_2g996f9jiukn-2{list-style-type:none}ul.lst-kix_2g996f9jiukn-3{list-style-type:none}.lst-kix_8kn17h8ds170-3>li:before{content:"\0025cf  "}.lst-kix_fznhohgbnnb3-1>li:before{content:"-  "}.lst-kix_8kn17h8ds170-2>li:before{content:"\0025a0  "}.lst-kix_cntx4tdr3vpo-7>li:before{content:"-  "}.lst-kix_fznhohgbnnb3-5>li:before{content:"-  "}.lst-kix_t453qbeg7yxi-0>li:before{content:"-  "}.lst-kix_cntx4tdr3vpo-6>li:before{content:"-  "}.lst-kix_fznhohgbnnb3-2>li:before{content:"-  "}.lst-kix_fznhohgbnnb3-6>li:before{content:"-  "}.lst-kix_sajvd0vs1jci-5>li:before{content:"-  "}ul.lst-kix_ks833lz1z7ql-5{list-style-type:none}ul.lst-kix_ks833lz1z7ql-4{list-style-type:none}ul.lst-kix_ks833lz1z7ql-3{list-style-type:none}ul.lst-kix_ks833lz1z7ql-2{list-style-type:none}ul.lst-kix_ks833lz1z7ql-1{list-style-type:none}ul.lst-kix_ks833lz1z7ql-0{list-style-type:none}.lst-kix_8kn17h8ds170-6>li:before{content:"\0025cf  "}.lst-kix_sajvd0vs1jci-6>li:before{content:"-  "}.lst-kix_t453qbeg7yxi-1>li:before{content:"-  "}.lst-kix_8kn17h8ds170-7>li:before{content:"\0025cb  "}.lst-kix_cntx4tdr3vpo-2>li:before{content:"-  "}.lst-kix_sajvd0vs1jci-1>li:before{content:"-  "}ul.lst-kix_ks833lz1z7ql-8{list-style-type:none}ul.lst-kix_ks833lz1z7ql-7{list-style-type:none}ul.lst-kix_ks833lz1z7ql-6{list-style-type:none}ul.lst-kix_sdd4j0g0i102-0{list-style-type:none}.lst-kix_cntx4tdr3vpo-3>li:before{content:"-  "}ul.lst-kix_sdd4j0g0i102-2{list-style-type:none}ul.lst-kix_sdd4j0g0i102-1{list-style-type:none}ul.lst-kix_sdd4j0g0i102-4{list-style-type:none}ul.lst-kix_sdd4j0g0i102-3{list-style-type:none}.lst-kix_sajvd0vs1jci-2>li:before{content:"-  "}ul.lst-kix_sdd4j0g0i102-6{list-style-type:none}ul.lst-kix_sdd4j0g0i102-5{list-style-type:none}.lst-kix_m3aaeizidpga-0>li:before{content:"-  "}.lst-kix_m3aaeizidpga-4>li:before{content:"-  "}.lst-kix_fntvcn41blca-2>li:before{content:"\0025a0  "}.lst-kix_fntvcn41blca-6>li:before{content:"\0025cf  "}.lst-kix_2g996f9jiukn-1>li:before{content:"-  "}.lst-kix_hsnn8cb3mf5v-7>li:before{content:"-  "}.lst-kix_3jq1ezcn055d-0>li:before{content:"-  "}.lst-kix_ypwh9jlsbvp5-1>li:before{content:"-  "}.lst-kix_t2ertrluue2s-3>li:before{content:"-  "}.lst-kix_kyi9mzn49gim-5>li:before{content:"-  "}.lst-kix_3jq1ezcn055d-8>li:before{content:"-  "}.lst-kix_sdd4j0g0i102-6>li:before{content:"-  "}.lst-kix_hsnn8cb3mf5v-3>li:before{content:"-  "}.lst-kix_ypwh9jlsbvp5-5>li:before{content:"-  "}.lst-kix_qvlhfeetlgn4-3>li:before{content:"-  "}.lst-kix_kyi9mzn49gim-1>li:before{content:"-  "}.lst-kix_qvlhfeetlgn4-7>li:before{content:"-  "}.lst-kix_8zh4qso6zamb-7>li:before{content:"-  "}.lst-kix_8zh4qso6zamb-3>li:before{content:"-  "}.lst-kix_gclj53ptxn94-3>li:before{content:"\0025cf  "}.lst-kix_lometsw9ge27-5>li:before{content:"-  "}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_sdd4j0g0i102-2>li:before{content:"-  "}.lst-kix_3jq1ezcn055d-4>li:before{content:"-  "}.lst-kix_gclj53ptxn94-7>li:before{content:"\0025cb  "}.lst-kix_lometsw9ge27-1>li:before{content:"-  "}ol{margin:0;padding:0}table td,table th{padding:0}.c30{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:0pt;border-right-width:0pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:0pt;border-top-style:solid;background-color:#f8f8f8;border-left-style:solid;border-bottom-width:0pt;width:468pt;border-top-color:#000000;border-bottom-style:solid}.c37{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:0pt;border-right-width:0pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:0pt;border-top-style:solid;background-color:#f8f8f8;border-left-style:solid;border-bottom-width:0pt;width:525pt;border-top-color:#000000;border-bottom-style:solid}.c26{border-right-style:solid;padding:10pt 10pt 10pt 10pt;border-bottom-color:#000000;border-top-width:0pt;border-right-width:0pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:0pt;border-top-style:solid;background-color:#ffffff;border-left-style:solid;border-bottom-width:0pt;width:500pt;border-top-color:#000000;border-bottom-style:solid}.c27{background-color:#f8f8f8;color:#333333;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Consolas";font-style:normal}.c4{background-color:#ddffdd;color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Consolas";font-style:normal}.c17{background-color:#f8f8f8;color:#333333;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:"Consolas";font-style:normal}.c29{background-color:#f8f8f8;color:#1d1c1d;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:"Consolas";font-style:normal}.c8{color:#aaaaaa;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Consolas";font-style:normal}.c21{color:#999999;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Consolas";font-style:normal}.c19{padding-top:16pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c10{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c13{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Consolas";font-style:normal}.c25{padding-top:18pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c31{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:20pt;font-family:"Arial";font-style:normal}.c18{padding-top:20pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c28{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Arial";font-style:normal}.c12{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:"Arial";font-style:normal}.c2{color:#434343;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:14pt;font-family:"Arial";font-style:normal}.c5{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c23{background-color:#f8f8f8;font-size:10pt;font-family:"Consolas";color:#333333;font-weight:400}.c16{margin-left:auto;border-spacing:0;border-collapse:collapse;margin-right:auto}.c0{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c6{padding-top:0pt;padding-bottom:0pt;line-height:1.15;text-align:left}.c14{background-color:#f5f5f5;font-family:"Consolas";color:#28782a;font-weight:400}.c33{padding-top:3pt;padding-bottom:3pt;line-height:1.50001;text-align:left}.c24{border-spacing:0;border-collapse:collapse;margin-right:auto}.c9{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c22{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#0000ee;text-decoration:underline}.c20{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c3{color:inherit;text-decoration:inherit}.c7{margin-left:36pt;padding-left:0pt}.c34{margin-left:72pt;padding-left:0pt}.c1{padding:0;margin:0}.c32{height:0pt}.c15{background-color:#ffdddd}.c11{height:11pt}.c35{vertical-align:super}.c36{margin-left:36pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c20"><h1 class="c18" id="h.b9p212y0m8e"><span class="c31">Fine-grained CPU attribution (30% draft)</span></h1><h2 class="c25" id="h.y8e22sako9gx"><span class="c28">Summary</span></h2><p class="c5"><span class="c10">We propose using a patched Go to track CPU utilization at the level of individual goroutines, using the primitive to derive an accurate resource consumption signal for various subsystems within CRDB.</span></p><h2 class="c25" id="h.oz0945a5xh55"><span class="c28">Motivation</span></h2><p class="c5"><span class="c10">CRDB lacks primitives to attribute CPU usage to specific scopes (ranges, tenants, sessions, statements) or processes (pebble compactions, snapshot generation). For subsystems that rely on such attribution, we use proxy signals like &#39;# of batch requests&#39; or &#39;size of read/write request&#39; as observed by a range/replica or a given tenant. With respect to modeling CPU usage, this is:</span></p><ul class="c1 lst-kix_qvlhfeetlgn4-0 start"><li class="c5 c7 li-bullet-0"><span class="c10">Inaccurate: two proportions of the signal can translate to different proportions of actual CPU usage;</span></li><li class="c5 c7 li-bullet-0"><span class="c10">Imprecise: repeated equal measurements the signal can correspond to varied actual CPU usage.</span></li></ul><p class="c5"><span class="c10">The inaccuracy and imprecision are due to:</span></p><ul class="c1 lst-kix_26xw8ufkmoyn-0 start"><li class="c5 c7 li-bullet-0"><span class="c10">Different batch requests having different compositions with respect to the underlying requests;</span></li></ul><ul class="c1 lst-kix_fznhohgbnnb3-0 start"><li class="c5 c7 li-bullet-0"><span class="c10">Different request types varying in how much CPU activity they incur;</span></li><li class="c5 c7 li-bullet-0"><span class="c10">Requests being variadic in their size and costing accordingly.</span></li></ul><p class="c5"><span>This can lead to suboptimal decisions (placement and forecasting in the allocator, resource control in the per-store tenant rate limiter), and is difficult to reason about. The latter also becomes important as we build </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://docs.google.com/document/d/1Cp-JVh460ezFaxd0ZglVFGa2orUvWPNXPJKpOgEfV6s/edit&amp;sa=D&amp;source=editors&amp;ust=1653016803065058&amp;usg=AOvVaw32ybQ77FQasbBL3clFGhaU">visualizations</a></span><span class="c10">&nbsp;for CRDB internal state for end-users.</span></p><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span class="c10">Our proxy signals don&rsquo;t generalize to other subsystems, some of which consequently are CPU unaware. Changefeed processor placement for e.g. is agnostic to the CPU usage driven by the processors themselves, and can lead to CPU hotspots and poor cluster-wide resource utilization. It&#39;s difficult today to answer how much cluster-wide CPU usage a single statement execution drove, or what % of CPU on a given node is due to activity on a specific index, or driven by a specific tenant.</span></p><h2 class="c25" id="h.4l22jmmupbok"><span class="c28">Design</span></h2><p class="c5"><span>The time spent per-goroutine in the running state (henceforth &ldquo;CPU time&rdquo;) is an accurate and precise measure for CPU usage . This is not currently tracked by the Go runtime (though there&#39;s an </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/golang/go/issues/41554&amp;sa=D&amp;source=editors&amp;ust=1653016803065836&amp;usg=AOvVaw0Dyy5H8QQmrOv5PNPAhHX9">issue</a></span><span class="c10">&nbsp;upstream); we propose doing so with the following patch:</span></p><p class="c5 c11"><span class="c10"></span></p><a id="t.54a4c9a472760e91886c291680ca49ba45a4b523"></a><a id="t.0"></a><table class="c16"><tr class="c32"><td class="c26" colspan="1" rowspan="1"><p class="c0"><span class="c21">diff --git a/src/runtime/runtime2.go b/src/runtime/runtime2.go</span></p><p class="c0"><span class="c21">index 1e4f872726..ced56dc4f6 100644</span></p><p class="c0"><span class="c13 c15">--- a/src/runtime/runtime2.go</span></p><p class="c0"><span class="c4">+++ b/src/runtime/runtime2.go</span></p><p class="c0"><span class="c8">@@ -488,6 +487,9 @@ type g struct {</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp;labels &nbsp; &nbsp; &nbsp; &nbsp; unsafe.Pointer // profiler labels</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp;timer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*timer &nbsp; &nbsp; &nbsp; &nbsp; // cached timer for time.Sleep</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp;selectDone &nbsp; &nbsp; uint32 &nbsp; &nbsp; &nbsp; &nbsp; // are we participating in a select and did someone win the race?</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp;lastsched &nbsp; &nbsp; &nbsp;int64 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// timestamp when the G last started running</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp;runningnanos &nbsp; int64 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// wall time spent in the running state</span></p><p class="c0 c11"><span class="c13"></span></p><p class="c0 c11"><span class="c13"></span></p><p class="c0"><span class="c21">diff --git a/src/runtime/proc.go b/src/runtime/proc.go</span></p><p class="c0"><span class="c21">index f5e528e8e9..9f938311b8 100644</span></p><p class="c0"><span class="c13 c15">--- a/src/runtime/proc.go</span></p><p class="c0"><span class="c4">+++ b/src/runtime/proc.go</span></p><p class="c0"><span class="c8">@@ -994,8 +994,18 @@ func casgstatus(gp *g, oldval, newval uint32) {</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp;}</span></p><p class="c0 c11"><span class="c13"></span></p><p class="c0"><span class="c13 c15">- &nbsp; &nbsp;// Handle tracking for scheduling latencies.</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp;// Handle tracking for scheduling and running latencies.</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp;now := nanotime()</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp;if newval == _Grunning {</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp; &nbsp; &nbsp;// We&#39;re transitioning into the running state, record the timestamp for</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp; &nbsp; &nbsp;// subsequent use.</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp; &nbsp; &nbsp;gp.lastsched = now</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp;}</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp;if oldval == _Grunning {</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp; &nbsp; &nbsp;// We&#39;re transitioning out of running, record how long we were in the</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp; &nbsp; &nbsp;// state.</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp; &nbsp; &nbsp;gp.runningnanos += now - gp.lastsched</span></p><p class="c0"><span class="c4">+</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// Track every 8th time a goroutine transitions out of running.</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if gp.trackingSeq%gTrackingPeriod == 0 {</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gp.tracking = true</span></p><p class="c0"><span class="c8">@@ -1007,14 +1017,12 @@ func casgstatus(gp *g, oldval, newval uint32) {</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// We transitioned out of runnable, so measure how much</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// time we spent in this state and add it to</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// runnableTime.</span></p><p class="c0"><span class="c13 c15">- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;now := nanotime()</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gp.runnableTime += now - gp.runnableStamp</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gp.runnableStamp = 0</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if newval == _Grunnable {</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// We just transitioned into runnable, so record what</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// time that happened.</span></p><p class="c0"><span class="c13 c15">- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;now := nanotime()</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gp.runnableStamp = now</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;} else if newval == _Grunning {</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// We&#39;re transitioning into running, so turn off</span></p><p class="c0"><span class="c8">@@ -3258,6 +3266,14 @@ func dropg() {</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp;setGNoWB(&amp;_g_.m.curg, nil)</span></p><p class="c0"><span class="c13">&nbsp;}</span></p><p class="c0 c11"><span class="c13"></span></p><p class="c0"><span class="c4">+// grunningnanos returns the wall time spent by current g in the running state.</span></p><p class="c0"><span class="c4">+// A goroutine may be running on an OS thread that&#39;s descheduled by the OS</span></p><p class="c0"><span class="c4">+// scheduler, this time still counts towards the metric.</span></p><p class="c0"><span class="c4">+func grunningnanos() int64 {</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp;gp := getg()</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp;return gp.runningnanos + nanotime() - gp.lastsched</span></p><p class="c0"><span class="c4">+}</span></p><p class="c0"><span class="c4">+</span></p><p class="c0"><span class="c13">&nbsp;// checkTimers runs any timers for the P that are ready.</span></p><p class="c0"><span class="c13">&nbsp;// If now is not 0 it is the current time.</span></p><p class="c0"><span class="c13">&nbsp;// It returns the passed time or the current time if now was passed as 0.</span></p><p class="c0"><span class="c8">@@ -3491,6 +3507,8 @@ func goexit0(gp *g) {</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp;gp.param = nil</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp;gp.labels = nil</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp;gp.timer = nil</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp;gp.lastsched = 0</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp;gp.runningnanos = 0</span></p><p class="c0 c11"><span class="c13"></span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp;if gcBlackenEnabled != 0 &amp;&amp; gp.gcAssistBytes &gt; 0 {</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// Flush assist credit to the global pool. This gives</span></p><p class="c0"><span class="c21">diff --git a/src/runtime/sizeof_test.go b/src/runtime/sizeof_test.go</span></p><p class="c0"><span class="c21">index 9ce0a3afcd..71de8052bd 100644</span></p><p class="c0"><span class="c13 c15">--- a/src/runtime/sizeof_test.go</span></p><p class="c0"><span class="c4">+++ b/src/runtime/sizeof_test.go</span></p><p class="c0"><span class="c8">@@ -21,7 +21,7 @@ func TestSizeof(t *testing.T) {</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;_32bit uintptr // size on 32bit platforms</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;_64bit uintptr // size on 64bit platforms</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp;}{</span></p><p class="c0"><span class="c13 c15">- &nbsp; &nbsp; &nbsp; &nbsp;{runtime.G{}, 240, 392}, &nbsp; // g, but exported for testing</span></p><p class="c0"><span class="c4">+ &nbsp; &nbsp; &nbsp; &nbsp;{runtime.G{}, 256, 408}, &nbsp; // g, but exported for testing</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{runtime.Sudog{}, 56, 88}, // sudog, but exported for testing</span></p><p class="c0"><span class="c13">&nbsp; &nbsp; &nbsp;}</span></p><p class="c0 c11"><span class="c10"></span></p></td></tr></table><p class="c5"><span>Background: The runtime maintains a </span><span class="c14">type g struct</span><span>&nbsp;for every goroutine, and the scheduler is responsible for transitioning each one through various </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/golang/go/blob/afd181cf0b69c3591d7e47ceca4fabf14434d77e/src/runtime/runtime2.go%23L14-L85&amp;sa=D&amp;source=editors&amp;ust=1653016803076512&amp;usg=AOvVaw0PeXT3vJwM6P6zD9nnVfc3">states</a></span><span>. </span><span class="c14">_Grunning</span><span>&nbsp;is the one we&#39;re interested in, which indicates that the goroutine may execute user (i.e. CRDB) code. The goroutine is also assigned to an OS thread (</span><span class="c14">type m struct</span><span>) that is in turn assigned to a CPU core (</span><span class="c14">type p struct</span><span>). In addition to the </span><span class="c14">src/runtime</span><span>&nbsp;</span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/golang/go/blob/cc4957a5f6eba946f359ed9646ec3e5083a259a9/src/runtime/proc.go%23L19-L111&amp;sa=D&amp;source=editors&amp;ust=1653016803077099&amp;usg=AOvVaw1kmg766SbHCbYLzkCL-ZHL">package docs</a></span><span>, </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://www.youtube.com/watch?v%3DYHRO5WQGh0k&amp;sa=D&amp;source=editors&amp;ust=1653016803077260&amp;usg=AOvVaw1deDYos9YZ1xFbOqybTtdA">Kavya Joshi&#39;s</a></span><span>&nbsp;and </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://www.youtube.com/watch?v%3D-K11rY57K7k&amp;sa=D&amp;source=editors&amp;ust=1653016803077396&amp;usg=AOvVaw1pPcX6u4CXPSedlIYSmJwR">Dmitry Vyukov&#39;s</a></span><span class="c10">&nbsp;presentations on the runtime internals can serve as helpful reading material.</span></p><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span>At the point where a </span><span class="c14">g</span><span>&nbsp;transitions in and out of the </span><span class="c14">_Grunning</span><span>&nbsp;state, we maintain per-</span><span class="c14">g</span><span>&nbsp;counters that capture the wall time spent in that state. It&#39;s possible for an OS thread (</span><span class="c14">m</span><span>) that a goroutine (</span><span class="c14">g</span><span>) was running on to be descheduled by the OS scheduler in favor of non-CRDB processes running on the same node. This is invisible to the Go runtime, and as such, the patch above will count this off-CPU time towards the per-</span><span class="c14">g</span><span class="c10">&nbsp;total (this is evaluated below).</span></p><h3 class="c19" id="h.jn96z17eyofh"><span class="c2">Comparison to RUs and &#39;# of batch requests&#39;</span></h3><p class="c5"><span class="c10">In multi-tenant environments we currently model CPU usage using a linear model of the &#39;# of read/write requests&#39; and their corresponding sizes. We use this linear model for cost attribution and resource control, models that are more or less accurate depending on how the running workload compares to the workloads we&#39;ve trained the linear model using. Improved signal accuracy for CPU translates to:</span></p><ul class="c1 lst-kix_kyi9mzn49gim-0 start"><li class="c5 c7 li-bullet-0"><span>Better </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://docs.google.com/spreadsheets/d/1_fm2chL5wp0nJVyyvhhWmX2MJ39U7WzRHxJ72J34OzU/edit%23gid%3D1218053456&amp;sa=D&amp;source=editors&amp;ust=1653016803078210&amp;usg=AOvVaw2bNW6mNuscFF-LMoiBM_1b">accounting</a></span><span>&nbsp;independent of the how we present </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://docs.google.com/document/d/1TIzDNnqGBrnT5CI13ML7Gcn38WjcSv-ZLkpP2FHjzNc/edit%23heading%3Dh.7st8bfobpddz&amp;sa=D&amp;source=editors&amp;ust=1653016803078407&amp;usg=AOvVaw1RrhvQ4c70Yy9I4dua3xDc">consumption</a></span><span class="c10">&nbsp;(RUs, rows read/written), we should know what patterns we&#39;re subsidizing;</span></li><li class="c5 c7 li-bullet-0"><span class="c10">Performance predictability in multi-tenant environments.</span></li></ul><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span>Derived signals like &#39;# of batch requests&#39; are hard to map to the underlying hardware capacities or utilization. Base signals like &#39;time-spent on CPU&#39;, in contrast, are easier to normalize to capacity and infer utilization from. We imagine introducing similar base signals for other resources of interest (disk IOPs and bandwidth) and tooling rebalancing algorithms to directly consider independent hardware dimensions separately instead of using </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/cockroachdb/cockroach/issues/34590&amp;sa=D&amp;source=editors&amp;ust=1653016803078850&amp;usg=AOvVaw0aGt2e-S42MNtiVh_SnRrp">signals that combine</a></span><span>&nbsp;dimensions.</span><span class="c35">[disk-util].</span></p><h3 class="c19" id="h.qog3o8xaffzi"><span class="c2">Short-term use cases</span></h3><p class="c5"><span class="c10">We propose the following features to build experience with using a modified runtime, and to further evaluate signal accuracy:</span></p><ul class="c1 lst-kix_ks833lz1z7ql-0 start"><li class="c5 c7 li-bullet-0"><span class="c10">Observability: A per-store CPU usage breakdown by ranges and tenants, powered by measured CPU time. We&#39;d make this accessible through vtables and include results in debug zips, serving as a CPU-only version of today&#39;s hot-ranges report. This was prototyped, results below.</span></li><li class="c5 c7 li-bullet-0"><span>Observability: Surfacing per-statement CPU time, cluster-wide, as part of </span><span class="c14">EXPLAIN ANALYZE</span><span class="c10">.</span></li><li class="c5 c7 li-bullet-0"><span>(stretch goal) Tenant isolation: Integrating measured CPU time in the </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/cockroachdb/cockroach/issues/77041&amp;sa=D&amp;source=editors&amp;ust=1653016803079434&amp;usg=AOvVaw3B_3i1yO7uI0qdqhDHk7jz">tenant rate limiter</a></span><span class="c10">&nbsp;to improve performance predictability observed by tenants sharing KV nodes. We foresee integrating the tenant rate limiter into admission control which would help evaluate how effect this is as a signal<br>for CPU resource control.</span></li></ul><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span>From an earlier </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/irfansharif/cockroach/tree/220505.cputime-demo&amp;sa=D&amp;source=editors&amp;ust=1653016803079706&amp;usg=AOvVaw3jkl2lgBDnumcfjJE9AmPm">prototype</a></span><span class="c10">&nbsp;exposing per-store replica/tenant CPU time:</span></p><p class="c5"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 693.50px; height: 455.75px;"><img alt="" src="images/image3.png" style="width: 693.50px; height: 455.75px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 696.50px; height: 457.02px;"><img alt="" src="images/image1.png" style="width: 696.50px; height: 457.02px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><h3 class="c19" id="h.u69leaall58k"><span class="c2">Usage across machines, goroutines and codepaths</span></h3><p class="c5"><span>It&#39;s common to spawn multiple goroutines for the same operation and to also do so across RPC boundaries. For the latter (if looking to accumulate cluster wide CPU usage for a given statement, for e.g.) we can propagate per-node request-scoped total CPU time using tracing events; this is plumbing that already exists. For request-scoped total CPU time across cooperating goroutines, we can atomically maintain a counter stashed in the surrounding context. To retrieve per-goroutine running time, we imagine doing so in libraries we already use to manage goroutine lifetimes (</span><span class="c14">Stopper</span><span>, </span><span class="c14">ctxgroup</span><span>), lending more weight to </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/cockroachdb/cockroach/issues/58164&amp;sa=D&amp;source=editors&amp;ust=1653016803080302&amp;usg=AOvVaw3-SKLkCy7zpKJV8IEVCBGq">banning</a></span><span>&nbsp;naked </span><span class="c14">go</span><span class="c10">s altogether.</span></p><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span>For work done per-store that&#39;s attributable to an individual range or tenant, we don&rsquo;t go through a single codepath (the </span><span class="c14">Sender</span><span class="c10">&nbsp;stack). Consider KV queues that step through individual replicas at a time and do some work on behalf of each one, work we&rsquo;d perhaps want to attribute to the specific replicas/tenants. In prototypes we captured CPU profiles from KV under stock workloads to get a broad sense of what stack traces are attributable to individual ranges/tenants, opted into tracking at those points (purple segments in the figure below) to maintain store-level view of how much CPU activity is driven by a specific range/tenant.</span></p><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 677.50px; height: 286.67px;"><img alt="" src="images/image2.png" style="width: 677.50px; height: 286.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><h3 class="c19" id="h.7js7lg54eidy"><span class="c2">Development and release</span></h3><p class="c5"><span>We point to </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/cockroachdb/cockroach/blob/1e1ff14e73680b1a0e2877f8dc0bc56a657fc50c/WORKSPACE%23L148-L150&amp;sa=D&amp;source=editors&amp;ust=1653016803080968&amp;usg=AOvVaw2fKX5n1MwsDqgRHEJN8DCX">mirrored artifacts</a></span><span>&nbsp;of the Go runtime that engineers use when building/running tests through Bazel. The official CRDB release binaries </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/cockroachdb/cockroach/pull/76897&amp;sa=D&amp;source=editors&amp;ust=1653016803081127&amp;usg=AOvVaw3vHJu_eVZlEM3G341U_hS7">use Bazel</a></span><span>, using the same mirrored runtime. Pointing to a modified runtime</span><span class="c35">[release-go]</span><span>&nbsp;is a matter of hosting it in publicly maintained buckets for things to &quot;just work&quot; (</span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/irfansharif/runner/blob/153154c3cd9825ef067a11bf98ef8b0501db54d0/WORKSPACE%23L38-L48&amp;sa=D&amp;source=editors&amp;ust=1653016803081334&amp;usg=AOvVaw0Jy0a3x9vCGAnZlOrztGPk">prototype</a></span><span>). As for </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://cockroachlabs.atlassian.net/browse/CRDB-8349&amp;sa=D&amp;source=editors&amp;ust=1653016803081487&amp;usg=AOvVaw3S8hqel2Pcn-zYf7cSEAvc">deprecated</a></span><span class="c10">-Make based workflows, we can ensure that CRDB library components/tests that make use of the runtime patch are gated behind a bazel-only build tag.</span></p><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span>Logistics aside, we argue that this proposal should be considered more along the lines of a patchset (and one that we </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/golang/go/pull/51347&amp;sa=D&amp;source=editors&amp;ust=1653016803081745&amp;usg=AOvVaw2DcVYrwQIukc1lEnBC2-EA">intend to upstream</a></span><span>)</span><span class="c10">&nbsp;than a hard fork. Independent of if/when it&rsquo;s upstreamed, we can avoid coupling using precise attribution to the major Go release the change possibly appears; the diff conservative specifically to ease applying it to minor/major Go releases going forward. We expect future proposals for runtime changes, if any, to be evaluated on their own terms (review expertise, upstream-ability, fallback behavior without runtime changes).</span></p><h2 class="c25" id="h.1t6tk4p38loy"><span class="c28">Evaluation</span></h2><p class="c5"><span>Under stock TPC-C runs (see </span><span class="c22"><a class="c3" href="https://www.google.com/url?q=https://docs.google.com/document/d/13Sl2HfCG0zx-hwwOtyOAUNada2Ue-Xflnsdp_79uWYg/edit%23heading%3Dh.r78hxqww593h&amp;sa=D&amp;source=editors&amp;ust=1653016803082138&amp;usg=AOvVaw1I4-RW-AbVluEqtgduD0jK">Precise CPU Measurement Experiments</a></span><span class="c10">) we verified that measured CPU time was:</span></p><ul class="c1 lst-kix_ypwh9jlsbvp5-0 start"><li class="c5 c7 li-bullet-0"><span class="c10">Stable over time, under idle conditions and sustained load;</span></li><li class="c5 c7 li-bullet-0"><span class="c10">Trends with actual CPU usage (baseline: CRDB process CPU %), can be normalized to capacity and used to forecast effect of range/tenant movement.</span></li></ul><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span>Retrieving the goroutine running time (included is the vDSO call to </span><span class="c14">nanotime()</span><span class="c10">) is in the order of nanoseconds:</span></p><p class="c5 c11"><span class="c10"></span></p><a id="t.58f03c8c3ea6fd2be89705cb1c636c650141a8fd"></a><a id="t.1"></a><table class="c24"><tr class="c32"><td class="c30" colspan="1" rowspan="1"><p class="c6"><span class="c23">goos: darwin<br>goarch: arm64<br>BenchmarkGRunningNanos<br>BenchmarkGRunningNanos-10 &nbsp; &nbsp; &nbsp; 370304833 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16.22 ns/op<br>BenchmarkGRunningNanos-10 &nbsp; &nbsp; &nbsp; 370541593 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16.21 ns/op<br>BenchmarkGRunningNanos-10 &nbsp; &nbsp; &nbsp; 370386583 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16.24 ns/op<br>BenchmarkGRunningNanos-10 &nbsp; &nbsp; &nbsp; 367708474 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16.21 ns/op<br>BenchmarkGRunningNanos-10 &nbsp; &nbsp; &nbsp; 369348088 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16.20 ns/op<br>PASS</span></p></td></tr></table><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span class="c10">Microbenchmarks from the Go runtime that evaluate scheduler behavior show no discernible difference:<br></span></p><a id="t.bec12725ccd4a41f0c139b1c07057cf427f1e71f"></a><a id="t.2"></a><table class="c24"><tr class="c32"><td class="c37" colspan="1" rowspan="1"><p class="c6"><span class="c23">name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; old time/op &nbsp; &nbsp;new time/op &nbsp; &nbsp;delta<br>PingPongHog-10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;263ns &plusmn; 7% &nbsp; &nbsp; 264ns &plusmn; 6% &nbsp; &nbsp;~ &nbsp; &nbsp; (p=0.853 n=10+10)<br>CreateGoroutines-10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 181ns &plusmn; 0% &nbsp; &nbsp; 180ns &plusmn; 0% &nbsp; &nbsp;~ &nbsp; &nbsp; (p=0.270 n=5+5)<br>CreateGoroutinesParallel-10 &nbsp; &nbsp; &nbsp; &nbsp;29.7ns &plusmn; 4% &nbsp; &nbsp;29.6ns &plusmn; 3% &nbsp; &nbsp;~ &nbsp; &nbsp; (p=0.841 n=5+5)<br>CreateGoroutinesCapture-10 &nbsp; &nbsp; &nbsp; &nbsp; 1.06&micro;s &plusmn; 1% &nbsp; &nbsp;1.05&micro;s &plusmn; 0% &nbsp;-0.70% &nbsp;(p=0.024 n=5+5)<br>CreateGoroutinesSingle-10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 221ns &plusmn; 5% &nbsp; &nbsp; 227ns &plusmn; 3% &nbsp; &nbsp;~ &nbsp; &nbsp; (p=0.310 n=5+5)<br>Matmult-10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.13ns &plusmn; 1% &nbsp; &nbsp;1.13ns &plusmn; 1% &nbsp; &nbsp;~ &nbsp; &nbsp; (p=0.341 n=5+5)<br>WakeupParallelSpinning/0s-10 &nbsp; &nbsp; &nbsp; 10.7&micro;s &plusmn; 0% &nbsp; &nbsp;10.8&micro;s &plusmn; 0% &nbsp; &nbsp;~ &nbsp; &nbsp; (p=0.159 n=4+5)<br>WakeupParallelSpinning/1&micro;s-10 &nbsp; &nbsp; &nbsp;14.8&micro;s &plusmn; 1% &nbsp; &nbsp;14.8&micro;s &plusmn; 0% &nbsp; &nbsp;~ &nbsp; &nbsp; (p=0.310 n=5+5)<br>WakeupParallelSpinning/2&micro;s-10 &nbsp; &nbsp; &nbsp;18.8&micro;s &plusmn; 0% &nbsp; &nbsp;18.8&micro;s &plusmn; 0% &nbsp; &nbsp;~ &nbsp; &nbsp; (p=1.000 n=5+5)<br>WakeupParallelSpinning/5&micro;s-10 &nbsp; &nbsp; &nbsp;30.9&micro;s &plusmn; 1% &nbsp; &nbsp;30.7&micro;s &plusmn; 0% &nbsp;-0.59% &nbsp;(p=0.008 n=5+5)<br>WakeupParallelSpinning/10&micro;s-10 &nbsp; &nbsp; 50.3&micro;s &plusmn; 0% &nbsp; &nbsp;50.3&micro;s &plusmn; 0% &nbsp; &nbsp;~ &nbsp; &nbsp; (p=0.690 n=5+5)<br>WakeupParallelSpinning/20&micro;s-10 &nbsp; &nbsp; 91.4&micro;s &plusmn; 0% &nbsp; &nbsp;91.2&micro;s &plusmn; 0% &nbsp; &nbsp;~ &nbsp; &nbsp; (p=0.095 n=5+5)<br>WakeupParallelSpinning/50&micro;s-10 &nbsp; &nbsp; &nbsp;175&micro;s &plusmn; 0% &nbsp; &nbsp; 175&micro;s &plusmn; 0% &nbsp; &nbsp;~ &nbsp; &nbsp; (p=0.841 n=5+5)<br>WakeupParallelSpinning/100&micro;s-10 &nbsp; &nbsp; 273&micro;s &plusmn; 0% &nbsp; &nbsp; 273&micro;s &plusmn; 0% &nbsp;+0.16% &nbsp;(p=0.016 n=5+4)<br><br>name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; old alloc/op &nbsp; new alloc/op &nbsp; delta<br>CreateGoroutinesCapture-10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 144B &plusmn; 0% &nbsp; &nbsp; &nbsp;144B &plusmn; 0% &nbsp; &nbsp;~ &nbsp; &nbsp; (all equal)<br><br>name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; old allocs/op &nbsp;new allocs/op &nbsp;delta<br>CreateGoroutinesCapture-10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5.00 &plusmn; 0% &nbsp; &nbsp; &nbsp;5.00 &plusmn; 0% &nbsp; &nbsp;~ &nbsp; &nbsp; (all equal)</span></p></td></tr></table><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span>The metric is also accurate (matches actual on-CPU proportions) and precise (repeated measurements have low variability). To verify, we used </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/irfansharif/runner/blob/3279169983005ccff797269df11bdc6e1897e48f/runtime_test.go%23L70-L172&amp;sa=D&amp;source=editors&amp;ust=1653016803083933&amp;usg=AOvVaw3iHv9M1_iYEYQ8_PfpS8qA">a form of</a></span><span>&nbsp;the tests proposed in </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/golang/go/issues/36821&amp;sa=D&amp;source=editors&amp;ust=1653016803084079&amp;usg=AOvVaw2K47mDLpPRLJGgRKz1VcDc">go#36821</a></span><span>: </span><span class="c14">TestEquivalentGoroutines</span><span>&nbsp;and </span><span class="c14">TestProportionalGoroutines</span><span>.</span></p><p class="c5 c11"><span class="c10"></span></p><a id="t.4a15927c02c4dc1abbad41c6037f268bdca1a908"></a><a id="t.3"></a><table class="c24"><tr class="c32"><td class="c30" colspan="1" rowspan="1"><p class="c6"><span class="c17">=== RUN &nbsp; TestEquivalentGoroutines &nbsp; &nbsp;# want ~10% for each</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 0&#39;s got &nbsp;9.98% of total time</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 1&#39;s got &nbsp;9.53% of total time</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 2&#39;s got &nbsp;9.22% of total time</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 3&#39;s got 10.42% of total time</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 4&#39;s got &nbsp;9.84% of total time</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 5&#39;s got 10.43% of total time</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 6&#39;s got 10.50% of total time</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 7&#39;s got 10.21% of total time</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 8&#39;s got 10.03% of total time</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 9&#39;s got &nbsp;9.86% of total time</span></p><p class="c6 c11"><span class="c17"></span></p><p class="c6"><span class="c17">=== RUN &nbsp; TestProportionalGoroutines &nbsp;# want incrementing multipliers</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 0&#39;s got &nbsp;1.87% of total time (1.000000x)</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 1&#39;s got &nbsp;3.60% of total time (1.931999x)</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 2&#39;s got &nbsp;5.41% of total time (2.899312x)</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 3&#39;s got &nbsp;7.21% of total time (3.864451x)</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 4&#39;s got &nbsp;9.11% of total time (4.880925x)</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 5&#39;s got 10.94% of total time (5.864723x)</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 6&#39;s got 12.77% of total time (6.842004x)</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 7&#39;s got 14.34% of total time (7.685840x)</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 8&#39;s got 16.58% of total time (8.885060x)</span></p><p class="c6"><span class="c17">&nbsp; &nbsp; 9&#39;s got 18.18% of total time (9.741030x)</span></p></td></tr></table><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span class="c10">TODO: Evaluate inaccuracy given time spent descheduled by the OS is also counted here. The Go scheduler tries its best to hog the processors it&rsquo;s been allotted, and given we&rsquo;re running goroutines much higher than the number of processors, the observed inaccuracy across all goroutines (only the ones pinned to a descheduled OS thread is overcounted) should be diminishingly small.</span></p><h2 class="c25" id="h.21zqrfejuwbs"><span class="c28">Alternatives</span></h2><h3 class="c19" id="h.7wqgqb15dn9"><span class="c2">Sampling profiler</span></h3><p class="c5"><span>We can get coarse-grained, non-instantaneous CPU attribution using pprof and </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://rakyll.org/profiler-labels/&amp;sa=D&amp;source=editors&amp;ust=1653016803087055&amp;usg=AOvVaw0Uw9DQjhEtOyGgnDZHUZ4Z">profiler labels</a></span><span>. A sketch of what this would look like was </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/cockroachdb/cockroach/pull/60508&amp;sa=D&amp;source=editors&amp;ust=1653016803087218&amp;usg=AOvVaw1dQWLgFVC_mcRx9KAVab_1">prototyped here</a></span><span class="c10">, and has roughly the following idea.</span></p><ul class="c1 lst-kix_m3aaeizidpga-0 start"><li class="c5 c7 li-bullet-0"><span class="c10">We&#39;d make use of profiler labels at points of interest (code paths where requests to a single range/tenant feed through for e.g.)</span></li><li class="c5 c7 li-bullet-0"><span class="c10">Go automatically propagates profiler labels across goroutine boundaries with shared contexts. gRPC also propagates labels across RPC boundaries.</span></li><li class="c5 c7 li-bullet-0"><span class="c10">We&#39;d periodically capture profiling data and use it to compute the %es of CPU time attributable to specific scopes.</span></li></ul><p class="c5 c11 c36"><span class="c10"></span></p><p class="c5"><span class="c10">Comparison:</span></p><ul class="c1 lst-kix_lometsw9ge27-0 start"><li class="c5 c7 li-bullet-0"><span class="c10">Does not necessitate runtime changes.</span></li><li class="c5 c7 li-bullet-0"><span class="c10">Provides coarse-grained attribution, which is likely sufficient for things like the allocator or the tenant rate limiter, but harder to apply to per-statement/request accounting.</span></li></ul><ul class="c1 lst-kix_lometsw9ge27-1 start"><li class="c5 c34 li-bullet-0"><span class="c10">Sampling rates have a maximum frequency of 100hz.</span></li><li class="c5 c34 li-bullet-0"><span class="c10">Sampling-backed signals are accurate over a larger number of samples (i.e. non-instantaneous), which is less-than-usable when we care about capturing CPU data for executions in the tail (think statements that don&#39;t take that long, don&#39;t happen frequently).</span></li></ul><ul class="c1 lst-kix_lometsw9ge27-0"><li class="c5 c7 li-bullet-0"><span>CPU profiling is allocation inefficient and has comparably higher performance overhead that prevents it from being always-on or at a high enough frequency, which has implications on fidelity. An </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/cockroachdb/cockroach/pull/60589%23pullrequestreview-596239390&amp;sa=D&amp;source=editors&amp;ust=1653016803087949&amp;usg=AOvVaw159zT4pmDisbZ-21uP4NBM">experiment</a></span><span class="c10">&nbsp;running kv100 in read-only mode observed a 6% drop in throughput when sampling at 100hz. Profiles also capture more the entire stack trace; for CPU attribution we only need to identify the running goroutine. (TODO: more numbers).</span></li></ul><ul class="c1 lst-kix_6uv5cm836ttd-0 start"><li class="c5 c7 li-bullet-0"><span>CPU attribution from sampling data can be inaccurate and imprecise, as observed in </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/golang/go/issues/36821&amp;sa=D&amp;source=editors&amp;ust=1653016803088187&amp;usg=AOvVaw35Ssmm4-qwZoYpcFk_baUZ">go#36821</a></span><span class="c10">; measured CPU time does better as shown in the evaluation above.</span></li></ul><h3 class="c19" id="h.k1nkiaczdaqj"><span class="c2">Task groups</span></h3><p class="c5"><span>Another proposal for CPU attribution is introducing two new abstractions in the Go runtime: </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/knz/cockroach/blob/20210215-task-group-rfc/docs/RFCS/20210215_task_groups.md%23task-group-abstraction&amp;sa=D&amp;source=editors&amp;ust=1653016803088586&amp;usg=AOvVaw1ytGM2g-qyvyeXBDQ8Hg4y">taskgroups</a></span><span>&nbsp;and </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/knz/cockroach/blob/20210215-task-group-rfc/docs/RFCS/20210215_task_groups.md%23task-group-abstraction&amp;sa=D&amp;source=editors&amp;ust=1653016803088773&amp;usg=AOvVaw0MBS8v0x_RTDwKHYPx7Yi_">inheritable goroutine IDs</a></span><span>. The proposal observes the need to accumulate timings (and other statistics, like memory usage) across a set of cooperating goroutines, and having the ability to retrieve goroutine timings from possibly another goroutine. It also segues into precise tracking of memory allocations and possibility of resource control within the runtime (we don&rsquo;t), and helpfully outlines a few other options for resource attribution and control from counting CPU ticks, using separate processes, and manual instrumentation.</span></p><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span class="c10">Comparison:</span></p><ul class="c1 lst-kix_t2ertrluue2s-0 start"><li class="c5 c7 li-bullet-0"><span class="c10">Among the alternatives listed here this is the closest one in spirit, differing in the specific runtime changes proposed (with library code implications). </span></li></ul><ul class="c1 lst-kix_t2ertrluue2s-1 start"><li class="c5 c34 li-bullet-0"><span class="c10">Maintaining a modified runtime is logistically easier now compared to when the proposal was authored given our Bazel investments.</span></li></ul><ul class="c1 lst-kix_8zh4qso6zamb-0 start"><li class="c5 c7 li-bullet-0"><span class="c10">Task groups pushes some of the cross-goroutine tracking logic into the runtime itself which makes it a larger patch set to maintain, and less likely to be upstreamed. This also has implications for reviewability. This proposal is a more targeted form, lifting as much as possible out of the runtime and into CRDB libraries.</span></li><li class="c5 c7 li-bullet-0"><span class="c10">Task groups let you read off counters before an &ldquo;inherited&rdquo; goroutine is done, which could matter for very long-lived goroutines. With this proposal, if we&rsquo;re interested in accumulating counters for long-lived goroutines, the goroutines would themselves have to retrieve their running time and maintain external counters. Possible, but perhaps more awkward.</span></li><li class="c5 c7 li-bullet-0"><span>Task groups make use of atomics to maintain running counters as opposed to uncontended per-</span><span class="c14">g</span><span class="c10">&nbsp;counters. This could be slower due to cache coherency protocols across processors but we suspect the effects would be negligible.</span></li><li class="c5 c7 li-bullet-0"><span class="c10">At a high-level, task groups are an opt-out form of timing tracking (a &ldquo;unrelated&rdquo; goroutine spawned off would have to be excluded from accumulating time into the parent task group). This proposal is more opt-in.</span></li></ul><h3 class="c19" id="h.1cycixs2l86i"><span class="c2">eBPF probes</span></h3><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span>Linux has the ability to define </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://www.brendangregg.com/blog/2015-06-28/linux-ftrace-uprobe.html&amp;sa=D&amp;source=editors&amp;ust=1653016803089770&amp;usg=AOvVaw33untJuggqnd1jM60alvqV">probes</a></span><span>&nbsp;at specific callsites in user-level code (which for us would include the Go runtime). This document is a good primer on </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/jav/systemtap/blob/master/runtime/uprobes/uprobes.txt&amp;sa=D&amp;source=editors&amp;ust=1653016803089968&amp;usg=AOvVaw3X5egQht4fYnKPXkSv7g_S">uprobes</a></span><span>&nbsp;specifically. We can run eBPF programs every time the callsite is executed and maintain state across invocations. We could then, in theory, instantiate maps keyed by the goroutine ID and maintain running counters (last ran, total ran) in the same way we&rsquo;re proposing above (</span><span class="c14">lastsched</span><span>, </span><span class="c14">runningnanos</span><span>) but without modifying the runtime itself. We&rsquo;d probe explicit callsites, probably the same as above, where </span><span class="c14">g</span><span class="c10">&rsquo;s change state and where they&rsquo;re created and destroyed. </span></p><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span>An unrelated </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://cockroachlabs.slack.com/archives/C9TGBJB44/p1622814301157500?thread_ts%3D1622807466.125500%26cid%3DC9TGBJB44&amp;sa=D&amp;source=editors&amp;ust=1653016803090386&amp;usg=AOvVaw2omFkiMxxcrsuM7lrvPtIB">example</a></span><span class="c10">&nbsp;of what this could look like with CRDB (probing the Go scheduler to figure out how often it&rsquo;s invoked, how often it sleeps, and a distribution of how long it does in so in nanoseconds):</span></p><p class="c5 c11"><span class="c10"></span></p><a id="t.3303d9a70b3115c5ce1e63377aa111a51ebe3deb"></a><a id="t.4"></a><table class="c24"><tr class="c32"><td class="c30" colspan="1" rowspan="1"><p class="c6"><span class="c23">sudo bpftrace -p 9593 -e &#39;<br>uprobe:/home/ubuntu/cockroach:runtime.schedule {<br> &nbsp; &nbsp;@in[tid] = 1;<br> &nbsp; &nbsp;@steal[tid] = 0;<br> &nbsp; &nbsp;@parkstart[tid] = 0;<br> &nbsp; &nbsp;@parkns[tid] = 0<br>} <br>uretprobe:/home/ubuntu/cockroach:runtime.runqsteal {<br> &nbsp; &nbsp;if (@in[tid] == 1 &amp;&amp; @steal[tid] == 0 &amp;&amp; retval != 0) { <br> &nbsp; &nbsp; &nbsp; &nbsp;@steal[tid] = 1<br> &nbsp; &nbsp;}<br>}<br>uprobe:/home/ubuntu/cockroach:runtime.notesleep {<br> &nbsp; &nbsp;if (@in[tid] == 1) { <br> &nbsp; &nbsp; &nbsp; &nbsp;@parkstart[tid] = nsecs<br> &nbsp; &nbsp;}<br>}<br>uretprobe:/home/ubuntu/cockroach:runtime.notesleep {<br> &nbsp; &nbsp;if (@in[tid] == 1) {<br> &nbsp; &nbsp; &nbsp; &nbsp;@parkns[tid] += (nsecs - @parkstart[tid]);<br> &nbsp; &nbsp; &nbsp; &nbsp;@parkstart[tid] = 0<br> &nbsp; &nbsp;}<br>}<br>uprobe:/home/ubuntu/cockroach:runtime.execute {<br> &nbsp; &nbsp;if (@in[tid] == 1) {<br> &nbsp; &nbsp; &nbsp; if (@steal[tid] == 1) { @steals += 1 }<br> &nbsp; &nbsp; &nbsp; if (@parkns[tid] &gt; 1) {<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @parks += 1;<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @park_dur = hist(@parkns[tid]);<br> &nbsp; &nbsp; &nbsp; }<br> &nbsp; &nbsp; &nbsp; @schedules += 1;<br> &nbsp; &nbsp; &nbsp; @in[tid] = 0;<br> &nbsp; &nbsp;}<br>}<br>interval:s:1 { <br> &nbsp; &nbsp;printf(&quot;schedules/s %d, steals/s %d, parks/s %d \n&quot;, @schedules, @steals, @parks);<br> &nbsp; &nbsp;print(@park_dur);<br> &nbsp; &nbsp;clear(@steals); &nbsp; &nbsp;<br> &nbsp; &nbsp;clear(@schedules);<br> &nbsp; &nbsp;clear(@parks);<br> &nbsp; &nbsp;clear(@park_dur);<br>}&#39;</span></p></td></tr></table><p class="c6 c11"><span class="c17"></span></p><a id="t.9186552b9a81cba475e30b5fe03e732874d2e0d3"></a><a id="t.5"></a><table class="c24"><tr class="c32"><td class="c30" colspan="1" rowspan="1"><p class="c6"><span class="c23">schedules/s 3796, steals/s 18, parks/s 3450 <br>@park_dur: <br>[4K, 8K) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|<br>[8K, 16K) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|<br>[16K, 32K) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|<br>[32K, 64K) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;27 |@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br>[64K, 128K) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 98 |@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br>[128K, 256K) &nbsp; &nbsp; &nbsp; &nbsp; 304 |@@@@@@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|<br>[256K, 512K) &nbsp; &nbsp; &nbsp; &nbsp; 975 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ |<br>[512K, 1M) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 590 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br>[1M, 2M) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 984 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|<br>[2M, 4M) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 351 |@@@@@@@@@@@@@@@@@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|<br>[4M, 8M) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;50 |@@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|<br>[8M, 16M) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 25 |@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br>[16M, 32M) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;27 |@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br>[32M, 64M) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;11 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|<br>[64M, 128M) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 | &nbsp; &nbsp; &nbsp; </span></p></td></tr></table><p class="c11 c33"><span class="c29"></span></p><p class="c5"><span class="c10">Comparison:</span></p><ul class="c1 lst-kix_cntx4tdr3vpo-0 start"><li class="c5 c7 li-bullet-0"><span class="c10">Linux-only.</span></li></ul><ul class="c1 lst-kix_hsnn8cb3mf5v-0 start"><li class="c5 c7 li-bullet-0"><span class="c10">Does not necessitate runtime changes but necessitates an understanding of runtime internals.</span></li><li class="c5 c7 li-bullet-0"><span class="c10">Can be used to probe OS scheduling events, something the Go runtime itself has no visibility into.</span></li><li class="c5 c7 li-bullet-0"><span class="c14">uretprobes</span><span>&nbsp;don&rsquo;t work in Go (see </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/iovisor/bcc/issues/1320&amp;sa=D&amp;source=editors&amp;ust=1653016803091930&amp;usg=AOvVaw0SUK5wUG8iXbRAvwLYLarR">bcc#1320</a></span><span>&nbsp;and </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/golang/go/issues/22008&amp;sa=D&amp;source=editors&amp;ust=1653016803092067&amp;usg=AOvVaw3XZga-xSeh6iwe_E1d63cI">go#22008</a></span><span class="c10">) because of stack rewriting the Go runtime does not expect when growing/shrinking stacks &ndash; programs will crash.</span></li></ul><ul class="c1 lst-kix_hsnn8cb3mf5v-1 start"><li class="c5 c34 li-bullet-0"><span>There are ways to </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/iovisor/bcc/issues/1320%23issuecomment-407927542&amp;sa=D&amp;source=editors&amp;ust=1653016803092316&amp;usg=AOvVaw0J5tCmwANh97yUQb4zvL4s">simulate</a></span><span>&nbsp;</span><span class="c14">uretprobes</span><span>&nbsp;through </span><span class="c14">uprobes</span><span class="c10">&nbsp;but it&rsquo;s more annoying to do.</span></li></ul><ul class="c1 lst-kix_hsnn8cb3mf5v-0"><li class="c5 c7 li-bullet-0"><span class="c10">eBPF probes have more overhead than tracking running nanos in the runtime itself (instrumented function calls take in the order of &micro;s as opposed to ns).</span></li><li class="c5 c7 li-bullet-0"><span>Recent </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://docs.px.dev/tutorials/custom-data/dynamic-go-logging/&amp;sa=D&amp;source=editors&amp;ust=1653016803092678&amp;usg=AOvVaw3e9r5mMAvzTrRjeHqcb1yQ">developments</a></span><span class="c10">&nbsp;in the eBPF + Go ecosystem might make things progressively less painful (libraries to read arguments from the Go stack, decoding Go structs).</span></li></ul><ul class="c1 lst-kix_hsnn8cb3mf5v-1 start"><li class="c5 c34 li-bullet-0"><span>The out-of-the-box </span><span class="c14">bpftrace</span><span>&nbsp;use of </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://www.brendangregg.com/BPF/bpftrace-cheat-sheet.html&amp;sa=D&amp;source=editors&amp;ust=1653016803092951&amp;usg=AOvVaw2qOW7SoKocU8T0S7UrTQyt">thread IDs</a></span><span>&nbsp;(</span><span class="c14">tid</span><span>&nbsp;in the snippet above) don&rsquo;t apply to Go, we need </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/surki/misc/blob/c343525e35a96497dd356c38921f25b22c77fcc9/go.stp%23L5-L21&amp;sa=D&amp;source=editors&amp;ust=1653016803093163&amp;usg=AOvVaw2PhQ_NZ5EX0St9XGxN6RUw">access to</a></span><span>&nbsp;Go routine IDs instead.</span></li></ul><h3 class="c19" id="h.sto8uamjm4j7"><span>A</span><span class="c2">dmission control slot times</span></h3><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span>CPU bound work (for e.g. KV-level request and SQL statement processing) gets queued through per-node </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://docs.google.com/document/d/1x4DxbOjwCK-zrfO0amFNfHUI5Wul6V_IdIG7QKC5yqQ/edit%23heading%3Dh.mal9ypa8z9pq&amp;sa=D&amp;source=editors&amp;ust=1653016803093617&amp;usg=AOvVaw1qBgLo5U3bTuRj_MoO773o">admission queues</a></span><span>&nbsp;to provide overload protection and fairness. Queued work is able to proceed once granted a slot, and we have visibility into when work for a given slot starts and ends. These wall time readings could serve as a proxy for CPU processing the work entailed; timings we could then use for per-store attribution to specific ranges or tenants. The </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://github.com/cockroachdb/cockroach/issues/75066%23issuecomment-1023407169&amp;sa=D&amp;source=editors&amp;ust=1653016803093798&amp;usg=AOvVaw14DEc7YmruYPZvI44gM-m7">inaccuracies</a></span><span class="c10">&nbsp;here stem from wait times in:</span></p><ul class="c1 lst-kix_2g996f9jiukn-0 start"><li class="c5 c7 li-bullet-0"><span class="c10">the Go scheduler after a work is slotted (though this is bounded by admission control, and affects all range/tenant-scoped work uniformly);</span></li><li class="c5 c7 li-bullet-0"><span class="c10">txn contention handling (something we can instrument and subtract by timing things within our concurrency control libraries);</span></li><li class="c5 c7 li-bullet-0"><span class="c10">I/O wait times.</span></li></ul><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span class="c10">Considerations:</span></p><ul class="c1 lst-kix_tttr5koclxv9-0 start"><li class="c5 c7 li-bullet-0"><span class="c10">Does not necessitate runtime changes.</span></li><li class="c5 c7 li-bullet-0"><span class="c10">Proxy for actual CPU time, but perhaps good enough for use cases we imagine needing accurate/precise CPU modeling for.</span></li><li class="c5 c7 li-bullet-0"><span class="c10">Usable for work that makes sense to enqueue through admission control (unclear if applies to all subsystems where CPU attribution could be used).</span></li></ul><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span class="c10">[^disk-util]: Unlike CPU, modeling capacity utilization for disks feels generally difficult. This is doubly so in virtualized environments where it&#39;s less clear how the I/O queue depths relate to the actual underlying disks, or how the disk bandwidth/IOPS observable in the VM through OS counters relate to what the VMs are provisioned for. We have and want to continue developing models of disk utilization for other reasons (admission control, dynamic snapshot rates, allocation, better utilization by background processes without foreground impact), independent of the CPU modeling this document proposes.</span></p><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span>[^release-go]: The official Go archives are built using the steps </span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://go.googlesource.com/build/%2B/refs/heads/master/cmd/release/release.go&amp;sa=D&amp;source=editors&amp;ust=1653016803094659&amp;usg=AOvVaw2cjIrr0p0aQR1s3a5mOw0n">here</a></span><span>.</span></p><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span class="c10">&mdash;</span></p><p class="c5 c11"><span class="c10"></span></p><p class="c5"><span class="c10">Earlier documents:</span></p><ul class="c1 lst-kix_t453qbeg7yxi-0 start"><li class="c5 c7 li-bullet-0"><span class="c22"><a class="c3" href="https://www.google.com/url?q=https://docs.google.com/document/d/1PlFOndFrwKJi-Swf3mU-qSQQSPvWM59nTX4LqHKaP6I/edit%23heading%3Dh.1fdtwe10pkkl&amp;sa=D&amp;source=editors&amp;ust=1653016803095121&amp;usg=AOvVaw1wpmuYWJyIr9EixnIlpb6o">Notes - Precise on-CPU measurements</a></span></li></ul><ul class="c1 lst-kix_sajvd0vs1jci-0 start"><li class="c5 c7 li-bullet-0"><span class="c22"><a class="c3" href="https://www.google.com/url?q=https://docs.google.com/document/d/1AUUew89OyGtYR6JdcdRhriU4UIETbtC3wjazyedOpkQ/edit%23heading%3Dh.sop2edqe1328&amp;sa=D&amp;source=editors&amp;ust=1653016803095335&amp;usg=AOvVaw2gcCZHcnsb1G-4v9nohu5Q">Notes - Breather week plan</a></span></li><li class="c5 c7 li-bullet-0"><span class="c22"><a class="c3" href="https://www.google.com/url?q=https://docs.google.com/document/d/13Sl2HfCG0zx-hwwOtyOAUNada2Ue-Xflnsdp_79uWYg/edit%23heading%3Dh.r78hxqww593h&amp;sa=D&amp;source=editors&amp;ust=1653016803095566&amp;usg=AOvVaw1iimdhCWuCnu9psMWvZpEb">Precise CPU Measurement Experiments</a></span></li><li class="c5 c7 li-bullet-0"><span class="c22"><a class="c3" href="https://www.google.com/url?q=https://docs.google.com/presentation/d/101f7WmqpnP2FCzt3LSAm-1T6ZpNga7pM-n0_kQytj4s/edit%23slide%3Did.g127fadc90c5_0_0&amp;sa=D&amp;source=editors&amp;ust=1653016803095805&amp;usg=AOvVaw11AW7PNMwYuW7Dha6eIoN6">Breather Week - CPU TIME</a></span><span>&nbsp;(</span><span class="c9"><a class="c3" href="https://www.google.com/url?q=https://drive.google.com/file/d/10eERDOt5m7HVWyuWlEOwNQq-FP-9q1L6/view&amp;sa=D&amp;source=editors&amp;ust=1653016803095973&amp;usg=AOvVaw3TkMaqqB3mgPScHdlBzaHR">Recording</a></span><span>; </span><span class="c10">starting at 1:10:32)</span></li></ul></body></html>